#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# Run lint-staged for staged files
npx lint-staged

# Check Flutter formatting and analysis if Flutter files are staged
if git diff --cached --name-only | grep -E "\.dart$" > /dev/null; then
  echo "📱 Checking Flutter code..."
  cd apps/flutter_app
  if [ -f "pubspec.yaml" ]; then
    dart format --set-exit-if-changed . || {
      echo "❌ Flutter code is not properly formatted. Run 'dart format .' to fix."
      exit 1
    }
    flutter analyze --fatal-infos || {
      echo "❌ Flutter analysis failed. Please fix the issues."
      exit 1
    }
  fi
  cd ../..
fi

# Check Python formatting and linting if Python files are staged
if git diff --cached --name-only | grep -E "\.py$" > /dev/null; then
  echo "🐍 Checking Python code..."
  cd apps/backend_app
  if [ -f "requirements.txt" ]; then
    black --check . || {
      echo "❌ Python code is not properly formatted. Run 'black .' to fix."
      exit 1
    }
    flake8 . || {
      echo "❌ Python linting failed. Please fix the issues."
      exit 1
    }
  fi
  cd ../..
fi

# Check TypeScript/JavaScript files if they are staged
if git diff --cached --name-only | grep -E "\.(ts|tsx|js|jsx)$" > /dev/null; then
  echo "🌐 Checking TypeScript/JavaScript code..."
  cd apps/corporate_site
  if [ -f "package.json" ]; then
    npm run lint || {
      echo "❌ TypeScript/JavaScript linting failed. Please fix the issues."
      exit 1
    }
  fi
  cd ../..
fi

echo "✅ Pre-commit checks passed!"