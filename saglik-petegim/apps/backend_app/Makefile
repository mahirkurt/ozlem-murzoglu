# SaÄŸlÄ±k PeteÄŸim Backend Makefile

.PHONY: help install dev prod test clean lint format migrate seed docker-up docker-down docs

# Default target
help: ## Show this help message
	@echo "SaÄŸlÄ±k PeteÄŸim Backend - Available Commands:"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "\033[36m\033[0m"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Development

install: ## Install dependencies with Poetry
	@echo "ðŸ“¦ Installing dependencies..."
	poetry install
	@echo "âœ… Dependencies installed!"

install-pip: ## Install dependencies with pip
	@echo "ðŸ“¦ Installing dependencies with pip..."
	pip install -r requirements.txt
	@echo "âœ… Dependencies installed!"

dev: ## Start development environment
	@echo "ðŸš€ Starting development environment..."
	@chmod +x scripts/start.sh
	@./scripts/start.sh

migrate: ## Run database migrations
	@echo "ðŸ—„ï¸ Running database migrations..."
	alembic upgrade head
	@echo "âœ… Migrations completed!"

migrate-create: ## Create new migration
	@echo "ðŸ“ Creating new migration..."
	@read -p "Migration name: " name; \
	alembic revision --autogenerate -m "$$name"

seed: ## Seed database with initial data
	@echo "ðŸŒ± Seeding database..."
	python -m app.scripts.seed_data
	@echo "âœ… Database seeded!"

##@ Docker

docker-up: ## Start Docker services
	@echo "ðŸ³ Starting Docker services..."
	docker-compose up -d --build
	@echo "âœ… Docker services started!"

docker-down: ## Stop Docker services
	@echo "ðŸ›‘ Stopping Docker services..."
	docker-compose down
	@echo "âœ… Docker services stopped!"

docker-logs: ## View Docker logs
	@echo "ðŸ“‹ Viewing Docker logs..."
	docker-compose logs -f api

docker-shell: ## Access Docker container shell
	@echo "ðŸš Accessing Docker container..."
	docker-compose exec api bash

docker-prod: ## Start production Docker services
	@echo "ðŸš€ Starting production services..."
	docker-compose -f docker-compose.prod.yml up -d --build
	@echo "âœ… Production services started!"

##@ Testing

test: ## Run tests
	@echo "ðŸ§ª Running tests..."
	pytest
	@echo "âœ… Tests completed!"

test-cov: ## Run tests with coverage
	@echo "ðŸ§ª Running tests with coverage..."
	pytest --cov=app --cov-report=html --cov-report=term
	@echo "âœ… Tests with coverage completed!"

test-integration: ## Run integration tests only
	@echo "ðŸ§ª Running integration tests..."
	pytest -m integration
	@echo "âœ… Integration tests completed!"

test-unit: ## Run unit tests only
	@echo "ðŸ§ª Running unit tests..."
	pytest -m unit
	@echo "âœ… Unit tests completed!"

##@ Code Quality

lint: ## Run linting
	@echo "ðŸ” Running linter..."
	flake8 app tests
	mypy app
	@echo "âœ… Linting completed!"

format: ## Format code
	@echo "ðŸŽ¨ Formatting code..."
	black app tests
	isort app tests
	@echo "âœ… Code formatted!"

format-check: ## Check code formatting
	@echo "ðŸ” Checking code formatting..."
	black --check app tests
	isort --check-only app tests
	@echo "âœ… Code formatting checked!"

##@ Database

db-reset: ## Reset database (WARNING: Deletes all data)
	@echo "âš ï¸  This will delete all data. Are you sure? [y/N]"
	@read -r response; \
	if [ "$$response" = "y" ] || [ "$$response" = "Y" ]; then \
		echo "ðŸ—„ï¸ Resetting database..."; \
		alembic downgrade base; \
		alembic upgrade head; \
		python -m app.scripts.seed_data; \
		echo "âœ… Database reset completed!"; \
	else \
		echo "âŒ Database reset cancelled."; \
	fi

db-shell: ## Access database shell
	@echo "ðŸš Accessing database..."
	docker-compose exec db psql -U postgres -d saglik_petegim

##@ Production

prod-deploy: ## Deploy to production
	@echo "ðŸš€ Deploying to production..."
	@echo "âš ï¸  Make sure you have set up production environment variables!"
	docker-compose -f docker-compose.prod.yml up -d --build
	@echo "âœ… Production deployment completed!"

prod-logs: ## View production logs
	@echo "ðŸ“‹ Viewing production logs..."
	docker-compose -f docker-compose.prod.yml logs -f api

prod-migrate: ## Run production migrations
	@echo "ðŸ—„ï¸ Running production migrations..."
	docker-compose -f docker-compose.prod.yml exec api alembic upgrade head
	@echo "âœ… Production migrations completed!"

##@ Utilities

clean: ## Clean up temporary files
	@echo "ðŸ§¹ Cleaning up..."
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf .coverage
	rm -rf htmlcov
	rm -rf dist
	rm -rf build
	@echo "âœ… Cleanup completed!"

docs: ## Generate API documentation
	@echo "ðŸ“š Generating documentation..."
	@echo "Starting API server to generate docs..."
	@echo "Visit http://localhost:8000/docs for interactive documentation"
	@echo "Visit http://localhost:8000/redoc for alternative documentation"

backup: ## Create database backup
	@echo "ðŸ’¾ Creating database backup..."
	@mkdir -p backups
	@timestamp=$$(date +"%Y%m%d_%H%M%S"); \
	docker-compose exec -T db pg_dump -U postgres saglik_petegim > "backups/backup_$$timestamp.sql"
	@echo "âœ… Database backup created!"

restore: ## Restore database from backup
	@echo "ðŸ“ Available backups:"
	@ls -la backups/*.sql 2>/dev/null || echo "No backups found"
	@echo "Enter backup filename (from backups/ directory):"
	@read -r backup_file; \
	if [ -f "backups/$$backup_file" ]; then \
		echo "ðŸ”„ Restoring database from $$backup_file..."; \
		docker-compose exec -T db psql -U postgres -d saglik_petegim < "backups/$$backup_file"; \
		echo "âœ… Database restored!"; \
	else \
		echo "âŒ Backup file not found!"; \
	fi

##@ Monitoring

status: ## Show service status
	@echo "ðŸ“Š Service Status:"
	@echo "===================="
	@docker-compose ps

health: ## Check service health
	@echo "ðŸ¥ Health Check:"
	@echo "=================="
	@curl -s http://localhost:8000/health | python -m json.tool || echo "API not responding"

logs-api: ## View API logs
	@docker-compose logs -f api

logs-celery: ## View Celery logs
	@docker-compose logs -f celery-worker

logs-db: ## View database logs
	@docker-compose logs -f db

##@ Security

security-check: ## Run security checks
	@echo "ðŸ”’ Running security checks..."
	@echo "Note: Install safety and bandit for comprehensive security scanning"
	@echo "pip install safety bandit"
	# safety check
	# bandit -r app/
	@echo "âœ… Security check completed!"

update-deps: ## Update dependencies
	@echo "ðŸ“¦ Updating dependencies..."
	poetry update
	@echo "âœ… Dependencies updated!"

##@ Quick Commands

quick-start: install migrate seed docker-up ## Quick start: install, migrate, seed, and start services
	@echo "ðŸŽ‰ Quick start completed! Visit http://localhost:8000/docs"

quick-reset: docker-down clean docker-up migrate seed ## Quick reset: stop, clean, start, migrate, and seed
	@echo "ðŸŽ‰ Quick reset completed! Visit http://localhost:8000/docs"

quick-test: format lint test ## Quick test: format, lint, and test
	@echo "ðŸŽ‰ Quick test completed!"